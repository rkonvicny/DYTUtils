@startuml SD-002_Save_JSON_Data
!theme vibrant
title Sekvenční diagram: UC-002 Uložení JSON dat do dokumentu

actor Widget
participant "DocExtCtrl\n(Orchestrator)" as DocExtCtrl
participant "DocHelperCtrl\n(Helper)" as DocHelperCtrl
entity Document
entity File
entity FileInfo

Widget -> DocExtCtrl : 1. saveJsonToDocument(documentTitle, fileName, jsonData)
activate DocExtCtrl

DocExtCtrl -> DocExtCtrl : 1.1 Serializuje jsonData (pokud je objekt)

DocExtCtrl -> DocHelperCtrl : 2. ensureDocumentExists(documentTitle)
activate DocHelperCtrl
DocHelperCtrl -> Document : 2.1 Zajistí/vytvoří dokument
activate Document
Document -->> DocHelperCtrl : DocumentInfo / chyba
deactivate Document

alt Dokument zajištěn/vytvořen
    DocHelperCtrl -->> DocExtCtrl : 2a. DocumentInfo
    deactivate DocHelperCtrl

    DocExtCtrl -> DocHelperCtrl : 3. lockDocument(docId)
    activate DocHelperCtrl
    DocHelperCtrl -> Document : 3.1 Zamkne dokument
    activate Document
    Document -->> DocHelperCtrl : potvrzení / chyba
    deactivate Document

    alt Dokument úspěšně zamčen
        DocHelperCtrl -->> DocExtCtrl : 3a. potvrzení zamčení
        deactivate DocHelperCtrl

        DocExtCtrl -> DocHelperCtrl : 4. deleteFileByNameFromDocument(docId, fileName)
        activate DocHelperCtrl
        DocHelperCtrl -> File : 4.1 Smaže existující soubor (pokud existuje)
        activate File
        File -->> DocHelperCtrl : potvrzení / chyba (i pokud soubor neexistuje, je to OK)
        deactivate File
        ' Chyba při mazání (pokud je kritická) by se řešila zde, ale pro přepsání je často OK, pokud soubor neexistuje
        ' Pro zjednodušení předpokládáme, že tento krok buď uspěje, nebo jeho "selhání" (nenalezení souboru) nebrání nahrání nového.
        DocHelperCtrl -->> DocExtCtrl : 4a. potvrzení (nebo info o nenalezení)
        deactivate DocHelperCtrl

        DocExtCtrl -> DocHelperCtrl : 5. uploadFileToDocument(docId, fileName, serializedJsonData, "application/json")
        activate DocHelperCtrl
        DocHelperCtrl -> File : 5.1 Nahraje nový soubor
        activate File
        File -->> DocHelperCtrl : FileInfo / chyba
        deactivate File

        alt Soubor úspěšně nahrán
            DocHelperCtrl -->> DocExtCtrl : 5a. FileInfo
            deactivate DocHelperCtrl

            DocExtCtrl -> DocHelperCtrl : 6. unlockDocument(docId)
            activate DocHelperCtrl
            DocHelperCtrl -> Document : 6.1 Odemkne dokument
            activate Document
            Document -->> DocHelperCtrl : potvrzení / chyba
            deactivate Document

            alt Dokument úspěšně odemčen
                DocHelperCtrl -->> DocExtCtrl : 6a. potvrzení odemčení
                deactivate DocHelperCtrl
                DocExtCtrl -> FileInfo : 7. (připraví FileInfo z 5a)
                DocExtCtrl -->> Widget : 8. Promise<FileInfo> (resolves with FileInfo from 5a)
            else Chyba při odemykání
                DocHelperCtrl -->> DocExtCtrl : <color:red>6b. chyba odemykání</color>
                deactivate DocHelperCtrl
                DocExtCtrl -> DocExtCtrl : <color:orange>Loguje chybu odemykání, ale operace uložení byla úspěšná</color>
                DocExtCtrl -> FileInfo : 7. (připraví FileInfo z 5a)
                DocExtCtrl -->> Widget : 8. Promise<FileInfo> (resolves with FileInfo from 5a)
            end

        else Chyba při nahrávání souboru
            DocHelperCtrl -->> DocExtCtrl : <color:red>5b. chyba nahrávání</color>
            deactivate DocHelperCtrl
            ' Pokus o odemčení dokumentu před rejectem
            DocExtCtrl -> DocHelperCtrl : unlockDocument(docId)
            activate DocHelperCtrl
            DocHelperCtrl -> Document : Odemkne dokument (best effort)
            Document -->> DocHelperCtrl
            deactivate Document
            DocHelperCtrl -->> DocExtCtrl
            deactivate DocHelperCtrl
            DocExtCtrl -->> Widget : <color:red>Promise (rejects: Chyba nahrávání souboru)</color>
        end

    else Chyba při zamykání dokumentu
        DocHelperCtrl -->> DocExtCtrl : <color:red>3b. chyba zamykání</color>
        deactivate DocHelperCtrl
        ' Není co odemykat, pokud zamčení selhalo
        DocExtCtrl -->> Widget : <color:red>Promise (rejects: Chyba zamykání dokumentu)</color>
    end

else Chyba při zajištění/vytvoření dokumentu
    DocHelperCtrl -->> DocExtCtrl : <color:red>2b. chyba</color>
    deactivate DocHelperCtrl
    DocExtCtrl -->> Widget : <color:red>Promise (rejects: Chyba zajištění dokumentu)</color>
end

deactivate DocExtCtrl

@enduml