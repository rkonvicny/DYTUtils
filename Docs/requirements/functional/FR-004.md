---
**ID Požadavku:** FR-004
**Datum Vytvoření:** 2025-05-10
**Autor Požadavku:** KONR
**Verze:** 0.3 (aktualizace aktéra)
---

### Název Funkčního Požadavku:
Modifikace JSON souboru na "Document" objektu (Check-out, Upload nové verze, Check-in)

**1. Popis Aktéra/Uživatele:**
   - Widget (který volá funkce této utility)

**2. Cíl/Potřeba Aktéra:**
   - Widget potřebuje aktualizovat obsah existujícího JSON souboru uloženého jako příloha k "Document" objektu v 3DEXPERIENCE.

**3. Popis Funkcionality:**
   - Utilita poskytne funkce (nebo jednu komplexní funkci) pro realizaci cyklu modifikace souboru:
     - **Check-out (Lock & Download - volitelné):** Zamčení souboru pro editaci a případné stažení aktuální verze.
     - **Upload nové verze na FCS:** Nahrání modifikovaného obsahu na File Collaboration Server.
     - **Check-in (Update file metadata):** Aktualizace metadat souboru v 3DEXPERIENCE s odkazem na novou verzi na FCS, odemčení souboru a vytvoření nové verze souboru v 3DX.
   - **Vstupní podmínky/Data:**
     - Identifikátor "Document" objektu (`docId`).
     - Název JSON souboru k modifikaci (`fileName`).
     - Nový JSON obsah (pro upload).
     - Volitelně komentář k check-inu.
     - Volitelně příznak `keepLocked` (zda má soubor zůstat zamčený i po check-inu).
   - **Hlavní scénář (Kroky):**
     1. Utilita přijme požadavek od Widgetu na modifikaci JSON souboru.
     2. Utilita získá `fileId` pro daný `fileName` a `docId` (např. voláním `GET /resources/v1/modeler/documents/{docId}/files`).
     3. **(Volitelný Check-out/Lock):** Utilita (nebo `Connector3DSpace.js`) může zavolat `PUT /resources/v1/modeler/documents/{docId}/files/{fileId}/CheckoutTicket`. Tím se soubor zamkne a získá se ticket pro stažení aktuální verze (pokud je to potřeba). Alternativně lze použít `PUT /resources/v1/modeler/documents/{docId}/reserve` pro zamčení celého dokumentu.
     4. **Získání Check-in Ticketu:** Utilita (nebo `Connector3DSpace.js`) zavolá `PUT /resources/v1/modeler/documents/{docId}/files/CheckinTicket`.
        - Vstup: `docId`.
        - Výstup: `ticketURL`, `ticketparamname`, `ticket`.
     5. **Upload nové verze na FCS:** Utilita převede nový JSON obsah na řetězec a (nebo `Connector3DSpace.js`) nahraje tento obsah na FCS server pomocí ticketu z kroku 4.
        - Výstup: Nový FCS `receipt`.
     6. **Check-in (Update File Metadata):** Utilita sestaví JSON payload pro request body podle schématu `files` (pole s jedním souborem).
        - Klíčové atributy v `dataelements`: `title` (název souboru), `receipt` (z kroku 5), `comments` (komentář k check-inu), `keepLocked` (typicky `false`).
        Utilita (nebo `Connector3DSpace.js`) zavolá `PUT /resources/v1/modeler/documents/{docId}/files/{fileId}` s tímto payloadem.
     7. **(Volitelné Unreserve/Unlock):** Pokud byl v kroku 3 použit `reserveDocument`, zavolá se `PUT /resources/v1/modeler/documents/{docId}/unreserve`. Pokud byl soubor zamčen přes `CheckoutTicket` a `keepLocked` v kroku 6 bylo `false`, měl by být soubor již odemčen.
     8. Utilita zpracuje odpověď.
   - **Výstupní podmínky/Data:**
     - Potvrzení o úspěšném dokončení každé operace.
     - Informace o nové verzi souboru (např. nový `revision` z odpovědi v kroku 6).
   - **Alternativní scénáře/Chybové stavy:**
     - Dokument nebo soubor neexistuje.
     - Soubor je zamčen jiným uživatelem (pokud se pokoušíme o Check-out/Lock).
     - Selhání některé z operací (získání ticketu, upload na FCS, update metadat).

**4. Kritéria Přijetí (Acceptance Criteria):**
   - Utilita umožňuje Widgetu provést celý cyklus check-out, upload nové verze a check-in pro JSON soubor.
   - Po úspěšném cyklu je obsah souboru v 3DEXPERIENCE aktualizován.
   - Je zajištěna integrita dat a správné verzování (pokud je implementováno).

**5. Priorita:**
   - [X] Mělo by být (High/Should-have) - Klíčové pro správu konfigurací.

**6. Závislosti:**
   - `\\3dexpprod\webapps\DYTUtils\webapps\DYTUtils\Connector3DSpace.js`.
   - WebAPI 3DEXPERIENCE pro operace check-in/check-out/správu verzí souborů.

**7. Předpoklady:**
   - Widget (resp. uživatel, v jehož kontextu Widget běží) je autentizován a má potřebná oprávnění pro modifikaci dokumentu a souborů.

**8. Otevřené Otázky/Poznámky:**
   - [VYŘEŠENO ČÁSTEČNĚ] Jak přesně budou tyto operace mapovány? -> Popsáno v krocích.
   - Bude krok "Check-out/Lock" povinný, nebo ho necháme na volajícím Widgetu? Pokud bude volitelný, jak utilita pozná, že má soubor zamknout/odemknout? (Možná přes parametry funkce utility).
   - Jak se bude řešit souběžný přístup, pokud více uživatelů zkusí modifikovat stejný soubor? (API by mělo vrátit chybu, pokud je soubor zamčený jiným uživatelem).
   - Může se při `PUT .../{docId}/files/{fileId}` měnit i `title` (název souboru)? Schéma `files.dataelements.title` má `x-ApplicableOperations: Create (Required), Read (Yes), Modify (No)`, což naznačuje, že název souboru se nemění touto operací. Přejmenování by byla asi jiná operace.
